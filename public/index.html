<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“ Memo App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container py-5">
        <h1 class="mb-4 text-center">ğŸ“ Memo</h1>

        <div class="row g-4">
            <!-- æ–°å»ºå¤‡å¿˜å½• -->
            <div class="col-12 col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">New Memo</h5>
                        <input type="text" id="newContent" class="form-control mb-3" placeholder="Enter your memo">
                        <button onclick="createMemo()" class="btn btn-primary w-100">Create</button>
                    </div>
                </div>
            </div>

            <!-- æŸ¥æ‰¾å¤‡å¿˜å½• -->
            <div class="col-12 col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Read a Memo</h5>
                        <input type="text" id="loadId" class="form-control mb-3" placeholder="Please enter ID">
                        <button onclick="loadMemo()" class="btn btn-success w-100">Retrieve</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œç»“æœæ˜¾ç¤º -->
        <div class="mt-4">
            <h5>ğŸ” Result</h5>
            <div id="resultBox" class="bg-white p-3 rounded shadow-sm" style="min-height: 120px;">
                <label for="memoContent" class="form-label"><strong>Memo Contents</strong></label>
                <textarea id="memoContent" class="form-control" rows="4" disabled></textarea>
            </div>
        </div>

        <!-- å…¨éƒ¨åˆ—è¡¨ -->
        <!-- <div class="mt-4">
            <h5 class="mb-2">ğŸ“‹ æ‰€æœ‰å¤‡å¿˜å½•</h5>
            <button onclick="loadAllMemos()" class="btn btn-outline-secondary mb-3">åŠ è½½å…¨éƒ¨</button>
            <ul id="memoList" class="list-group"></ul>
        </div> -->
    </div>

    <!-- è„šæœ¬éƒ¨åˆ† -->
    <script>
        async function createMemo() {
            const content = document.getElementById('newContent').value.trim();
            if (!content) return alert('Content cannot be empty');

            const res = await fetch('/api/memos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });

            const data = await res.json();
            bindMemoToTextarea(data.id, data.content);
            document.getElementById('loadId').value = data.id;
            document.getElementById('newContent').value = '';
            window.history.pushState(null, '', `/${data.id}`);
            loadAllMemos();
        }

        async function loadMemo() {
            const id = document.getElementById('loadId').value.trim();
            if (!id) return alert('Please enter an ID');

            const res = await fetch(`/api/memos/${id}`);
            const data = await res.json();
            bindMemoToTextarea(data.id, data.content);
        }

        async function loadAllMemos() {
            const res = await fetch('/api/memos');
            const data = await res.json();

            const list = document.getElementById('memoList');
            if (!list) return;

            list.innerHTML = data.length === 0
                ? '<li class="list-group-item text-muted">Empty</li>'
                : '';

            data.forEach(memo => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                <span><strong>ID:</strong> ${memo.id} â€” ${memo.content}</span>
                <button class="btn btn-sm btn-danger" onclick="deleteMemo('${memo.id}')">Delete</button>
            `;
                list.appendChild(li);
            });
        }

        async function deleteMemo(id) {
            if (!confirm(`Are you sure to delete Memo ${id}?`)) return;
            await fetch(`/api/memos/${id}`, { method: 'DELETE' });
            loadAllMemos();
        }

        // è‡ªåŠ¨ç»‘å®šåˆ° textarea å¹¶ç›‘å¬ä¿å­˜
        function bindMemoToTextarea(id, content) {
            const textarea = document.getElementById('memoContent');
            textarea.value = content;
            textarea.disabled = false;
            textarea.dataset.memoId = id;

            // æ¸…é™¤ä¹‹å‰çš„ç›‘å¬
            textarea.oninput = null;

            let saveTimer;
            textarea.oninput = () => {
                const content = textarea.value;
                clearTimeout(saveTimer);
                saveTimer = setTimeout(async () => {
                    await fetch(`/api/memos/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content })
                    });
                    loadAllMemos();
                }, 500);
            };
        }

        // åŠ è½½æŒ‡å®š ID
        async function loadMemoById(id) {
            const res = await fetch(`/api/memos/${id}`);
            const data = await res.json();
            bindMemoToTextarea(data.id, data.content);
        }

        // é¡µé¢åŠ è½½å
        document.addEventListener('DOMContentLoaded', () => {
            // è·å– pathname æœ€åä¸€æ®µéç©ºè·¯å¾„ï¼Œä¾‹å¦‚ /note/abc/xyz â†’ "xyz"
            const segments = window.location.pathname.split('/').filter(Boolean);
            const lastSegment = segments[segments.length - 1];

            if (lastSegment) {
                loadMemoById(lastSegment);
                // è‡ªåŠ¨å¡«å…… ID
                document.getElementById('loadId').value = lastSegment;
            }


            loadAllMemos();
        });
    </script>


</body>

</html>